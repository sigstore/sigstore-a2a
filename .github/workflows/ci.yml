# Copyright 2025 The Sigstore Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write  # Required for Sigstore OIDC
  attestations: write # Required for GitHub Attestations

jobs:
  # Minimal test on push (cheap) - single Python version, single OS
  test-minimal:
    name: Test Suite (Minimal)
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Set up Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache UV dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            %LOCALAPPDATA%\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          make install-dev

      - name: Run tests
        run: |
          make test

  # Full test matrix on PR only (expensive)
  test:
    name: Test Suite - Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13']
        os: [ubuntu-latest, macos-latest, windows-latest]
        exclude:
          # Reduce matrix size - test all Python versions on Linux, but only latest on macOS/Windows
          - os: macos-latest
            python-version: '3.11'
          - os: macos-latest
            python-version: '3.12'
          - os: windows-latest
            python-version: '3.11'
          - os: windows-latest
            python-version: '3.12'

    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v5

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@4f41a90a1f38628c7ccc608d05fbafe701bc20ae # v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache UV dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            %LOCALAPPDATA%\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          make install-dev

      - name: Run tests
        run: |
          make test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  test-cli:
    name: CLI Integration Tests - ${{ startsWith(matrix.os, 'macos-') && 'macOS' || startsWith(matrix.os, 'windows-') && 'Windows' || 'Linux' }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'pull_request'
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v5

      - name: Set up Python
        uses: actions/setup-python@4f41a90a1f38628c7ccc608d05fbafe701bc20ae # v6
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache UV dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            %LOCALAPPDATA%\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          make install

      - name: Test CLI help
        run: |
          uv run sigstore-a2a --help
          uv run sigstore-a2a sign --help
          uv run sigstore-a2a verify --help


  build:
    name: Build Package - ${{ startsWith(matrix.os, 'macos-') && 'macOS' || startsWith(matrix.os, 'windows-') && 'Windows' || 'Linux' }}
    runs-on: ${{ matrix.os }}
    if: github.event_name == 'pull_request'
    needs: [test, test-cli]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v5

      - name: Set up Python
        uses: actions/setup-python@4f41a90a1f38628c7ccc608d05fbafe701bc20ae # v6
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache UV dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            %LOCALAPPDATA%\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Build package
        run: |
          make build

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist-${{ matrix.os }}
          path: dist/
          retention-days: 7

  sign-agent-card:
    name: Sign Example Agent Card
    runs-on: ubuntu-latest
    needs: [test-minimal, test, test-cli]
    if: |
      always() && (
        (github.event_name == 'push' && needs.test-minimal.result == 'success') ||
        (github.event_name == 'pull_request' && needs.test.result == 'success' && needs.test-cli.result == 'success')
      )
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@0c366fd6a839edf440554fa01a7085ccba70ac98 # v5

      - name: Set up Python
        uses: actions/setup-python@4f41a90a1f38628c7ccc608d05fbafe701bc20ae # v6
        with:
          python-version: '3.13'

      - name: Install UV
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Cache UV dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/uv
            %LOCALAPPDATA%\uv\cache
          key: ${{ runner.os }}-uv-${{ hashFiles('uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          make install

      - name: Store beacon token into oidc-token.txt
        uses: sigstore-conformance/extremely-dangerous-public-oidc-beacon@1e3cabecd3790f48b79a795424e12fa3cb880dcb # main

      - name: Sign example Agent Card
        run: |
          uv run sigstore-a2a sign \
            --output signed-example.json \
            --repository ${{ github.repository }} \
            --provenance \
            --identity_token "$(cat oidc-token.txt)" \
            example_agentcard.json

      - name: Verify signed Agent Card
        run: |
          uv run sigstore-a2a --verbose verify \
            --identity_provider "https://token.actions.githubusercontent.com" \
            --repository "sigstore-conformance/extremely-dangerous-public-oidc-beacon" \
            --workflow "Extremely dangerous OIDC beacon" \
            signed-example.json

      - name: Upload signed Agent Card
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: signed-agent-card
          path: signed-example.json
          retention-days: 30
